struggling with some legacy code 